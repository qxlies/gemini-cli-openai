# ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ğ¿Ñ€Ğ¾ĞºÑĞ¸

## ğŸ—ï¸ ĞĞ±Ñ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Ğ’Ğ°ÑˆĞµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ                              â”‚
â”‚                    (npm start)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OpenAI Route Handler                                â”‚
â”‚         (src/routes/openai.ts:31)                               â”‚
â”‚                                                                  â”‚
â”‚  POST /v1/chat/completions                                      â”‚
â”‚  â”œâ”€ ĞŸĞ°Ñ€ÑĞ¸Ñ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ                                               â”‚
â”‚  â”œâ”€ Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ                                           â”‚
â”‚  â””â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ GeminiApiClient                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              GeminiApiClient                                     â”‚
â”‚         (src/gemini-client.ts)                                  â”‚
â”‚                                                                  â”‚
â”‚  streamContent() Ğ¸Ğ»Ğ¸ getCompletion()                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         getProxyDispatcher()                                     â”‚
â”‚         (src/config.ts:23-57)                                   â”‚
â”‚                                                                  â”‚
â”‚  1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Node.js Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ                                 â”‚
â”‚  2. Ğ§Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ:                                â”‚
â”‚     - HTTPS_PROXY / https_proxy                                 â”‚
â”‚     - HTTP_PROXY / http_proxy                                   â”‚
â”‚     - ALL_PROXY / all_proxy                                     â”‚
â”‚     - NO_PROXY / no_proxy                                       â”‚
â”‚  3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ (NO_PROXY)                             â”‚
â”‚  4. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ProxyAgent (undici)                                 â”‚
â”‚  5. Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ñ€Ğ¾ĞºÑĞ¸                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                    â”‚          â”‚
                    â–¼          â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ProxyAgent   â”‚  â”‚ undefined    â”‚
            â”‚ (Ğ¿Ñ€Ğ¾ĞºÑĞ¸      â”‚  â”‚ (Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾ĞºÑĞ¸) â”‚
            â”‚  Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½)    â”‚  â”‚              â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                 â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              fetch() Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ                                      â”‚
â”‚         (src/gemini-client.ts:500-508)                          â”‚
â”‚                                                                  â”‚
â”‚  const response = await fetch(url, {                            â”‚
â”‚    method: "POST",                                              â”‚
â”‚    headers: {...},                                              â”‚
â”‚    body: JSON.stringify(streamRequest),                         â”‚
â”‚    dispatcher,  â† ProxyAgent Ğ¸Ğ»Ğ¸ undefined                      â”‚
â”‚  })                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                    â”‚          â”‚
                    â–¼          â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ĞŸÑ€Ğ¾ĞºÑĞ¸-ÑĞµÑ€Ğ²ĞµÑ€â”‚  â”‚ ĞŸÑ€ÑĞ¼Ğ¾Ğµ       â”‚
            â”‚              â”‚  â”‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ  â”‚
            â”‚ proxy.com:80 â”‚  â”‚              â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                 â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Google Gemini API                                        â”‚
â”‚    cloudcode-pa.googleapis.com                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼

```
Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getProxyDispatcher() Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Node.js
    â”‚  â””â”€ [Proxy] Not running in Node.js... (ĞµÑĞ»Ğ¸ Ğ½Ğµ Node.js)
    â”‚
    â”œâ”€ Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
    â”‚  â””â”€ Ğ˜Ñ‰ĞµÑ‚ HTTPS_PROXY, HTTP_PROXY, ALL_PROXY
    â”‚
    â”œâ”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° NO_PROXY
    â”‚  â”œâ”€ Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾ÑÑ‚ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ:
    â”‚  â”‚  â””â”€ [Proxy] Bypassing proxy for host: ...
    â”‚  â”‚
    â”‚  â””â”€ Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾ÑÑ‚ Ğ½Ğµ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ:
    â”‚     â””â”€ (Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ)
    â”‚
    â”œâ”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞºÑĞ¸ URL
    â”‚  â”œâ”€ Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½:
    â”‚  â”‚  â””â”€ [Proxy] No proxy configured in environment variables
    â”‚  â”‚
    â”‚  â””â”€ Ğ•ÑĞ»Ğ¸ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½:
    â”‚     â””â”€ (Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ)
    â”‚
    â”œâ”€ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ undici
    â”‚  â”œâ”€ Ğ•ÑĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:
    â”‚  â”‚  â””â”€ [Proxy] undici.ProxyAgent not available
    â”‚  â”‚
    â”‚  â””â”€ Ğ•ÑĞ»Ğ¸ ÑƒÑĞ¿ĞµÑ…:
    â”‚     â””â”€ (Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ)
    â”‚
    â””â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ProxyAgent
       â”œâ”€ Ğ•ÑĞ»Ğ¸ ÑƒÑĞ¿ĞµÑ…:
       â”‚  â””â”€ [Proxy] Using proxy for https://...: http://proxy.com:***@8080
       â”‚     â””â”€ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ProxyAgent
       â”‚
       â””â”€ Ğ•ÑĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:
          â””â”€ [Proxy] Error creating proxy dispatcher: ...
             â””â”€ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ undefined
```

---

## ğŸ”„ Ğ–Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°

### Ğ¡ Ğ¿Ñ€Ğ¾ĞºÑĞ¸ âœ…

```
1. ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
   POST /v1/chat/completions
   
2. OpenAIRoute Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
   â””â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ GeminiApiClient
   
3. GeminiApiClient.streamContent() Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ
   â””â”€ Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ getProxyDispatcher()
   
4. getProxyDispatcher() Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ProxyAgent
   â””â”€ [Proxy] Using proxy for https://...: http://proxy.com:8080
   
5. fetch() Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ dispatcher
   â””â”€ [GeminiAPI] Stream request will be routed through proxy
   
6. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¸Ğ´ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾ĞºÑĞ¸-ÑĞµÑ€Ğ²ĞµÑ€
   ĞšĞ»Ğ¸ĞµĞ½Ñ‚ â†’ ĞŸÑ€Ğ¾ĞºÑĞ¸ â†’ Google API
   
7. ĞÑ‚Ğ²ĞµÑ‚ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾ĞºÑĞ¸
   Google API â†’ ĞŸÑ€Ğ¾ĞºÑĞ¸ â†’ ĞšĞ»Ğ¸ĞµĞ½Ñ‚
   
8. ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚
```

### Ğ‘ĞµĞ· Ğ¿Ñ€Ğ¾ĞºÑĞ¸ âšª

```
1. ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
   POST /v1/chat/completions
   
2. OpenAIRoute Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
   â””â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ GeminiApiClient
   
3. GeminiApiClient.streamContent() Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ
   â””â”€ Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ getProxyDispatcher()
   
4. getProxyDispatcher() Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ undefined
   â””â”€ [Proxy] No proxy configured in environment variables
   
5. fetch() Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ±ĞµĞ· dispatcher
   â””â”€ [GeminiAPI] Stream request will be sent directly (no proxy)
   
6. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¸Ğ´ĞµÑ‚ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
   ĞšĞ»Ğ¸ĞµĞ½Ñ‚ â†’ Google API
   
7. ĞÑ‚Ğ²ĞµÑ‚ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
   Google API â†’ ĞšĞ»Ğ¸ĞµĞ½Ñ‚
   
8. ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚
```

---

## ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²

```
src/
â”œâ”€â”€ config.ts                    â† getProxyDispatcher()
â”‚   â”œâ”€â”€ getProxyDispatcher()     â† ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
â”‚   â””â”€â”€ shouldBypassProxy()      â† ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° NO_PROXY
â”‚
â”œâ”€â”€ gemini-client.ts             â† Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ĞºÑĞ¸
â”‚   â”œâ”€â”€ performStreamRequest()   â† Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ getProxyDispatcher()
â”‚   â”‚   â””â”€â”€ fetch() Ñ dispatcher
â”‚   â”‚
â”‚   â””â”€â”€ streamContent()          â† Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
â”‚
â””â”€â”€ routes/
    â””â”€â”€ openai.ts                â† Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ° API
        â””â”€â”€ POST /chat/completions
            â””â”€â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ GeminiApiClient

Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ:
â”œâ”€â”€ PROXY_USAGE.md               â† ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
â”œâ”€â”€ PROXY_EXAMPLES.md            â† ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ¸ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸
â”œâ”€â”€ PROXY_CHEATSHEET.md          â† Ğ¨Ğ¿Ğ°Ñ€Ğ³Ğ°Ğ»ĞºĞ°
â””â”€â”€ PROXY_ARCHITECTURE.md        â† Ğ­Ñ‚Ğ° Ñ„Ğ°Ğ¹Ğ»
```

---

## ğŸ” Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº getProxyDispatcher()

```typescript
export async function getProxyDispatcher(
  env: Record<string, unknown>,
  targetUrl: string
): Promise<any | undefined> {
  
  // Ğ¨Ğ°Ğ³ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Node.js
  const isNode = typeof process !== "undefined" && !!(process as any).versions?.node;
  if (!isNode) {
    console.log("[Proxy] Not running in Node.js environment, proxy disabled");
    return undefined;  // â† Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ´Ğ»Ñ non-Node Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¹
  }
  
  try {
    // Ğ¨Ğ°Ğ³ 2: Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…
    const envStr = (k: string) => {
      const v = (env?.[k as keyof typeof env] as string | undefined) 
             || (process.env[k] as string | undefined);
      return typeof v === "string" && v.trim() ? v.trim() : undefined;
    };
    
    // Ğ¨Ğ°Ğ³ 3: ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ñ†ĞµĞ»ĞµĞ²Ğ¾Ğ³Ğ¾ URL
    const urlObj = new URL(targetUrl);
    const isHttps = urlObj.protocol === "https:";
    const noProxy = envStr("NO_PROXY") || envStr("no_proxy");
    
    // Ğ¨Ğ°Ğ³ 4: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° NO_PROXY
    if (noProxy && shouldBypassProxy(urlObj.hostname, noProxy)) {
      console.log(`[Proxy] Bypassing proxy for host: ${urlObj.hostname}...`);
      return undefined;  // â† Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ‹Ñ… Ñ…Ğ¾ÑÑ‚Ğ¾Ğ²
    }
    
    // Ğ¨Ğ°Ğ³ 5: Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾ĞºÑĞ¸
    const proxyUrl = (
      isHttps 
        ? envStr("HTTPS_PROXY") || envStr("https_proxy")
        : envStr("HTTP_PROXY") || envStr("http_proxy")
    ) || envStr("ALL_PROXY") || envStr("all_proxy");
    
    if (!proxyUrl) {
      console.log("[Proxy] No proxy configured in environment variables");
      return undefined;  // â† Ğ’Ñ‹Ñ…Ğ¾Ğ´ ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾ĞºÑĞ¸ Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½
    }
    
    // Ğ¨Ğ°Ğ³ 6: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ undici
    const undici: any = await import("undici");
    if (!undici?.ProxyAgent) {
      console.warn("[Proxy] undici.ProxyAgent not available");
      return undefined;  // â† Ğ’Ñ‹Ñ…Ğ¾Ğ´ ĞµÑĞ»Ğ¸ undici Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
    }
    
    // Ğ¨Ğ°Ğ³ 7: ĞœĞ°ÑĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…
    const maskedProxyUrl = proxyUrl.replace(
      /(:\/\/)([^:]+):([^@]+)@/,
      "$1$2:***@"
    );
    console.log(
      `[Proxy] Using proxy for ${targetUrl}: ${maskedProxyUrl}`
    );
    
    // Ğ¨Ğ°Ğ³ 8: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ ProxyAgent
    return new undici.ProxyAgent(proxyUrl);  // â† Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ
    
  } catch (error) {
    // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
    console.error(
      "[Proxy] Error creating proxy dispatcher:",
      error instanceof Error ? error.message : String(error)
    );
    return undefined;  // â† Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
  }
}
```

---

## ğŸ¯ Ğ¢Ğ¾Ñ‡ĞºĞ¸ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸

### 1. ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ (src/config.ts)

```typescript
// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ getProxyDispatcher
export async function getProxyDispatcher(
  env: Record<string, unknown>,
  targetUrl: string
): Promise<any | undefined>
```

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:**
- Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° NO_PROXY
- Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ProxyAgent
- Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

---

### 2. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (src/gemini-client.ts)

```typescript
// Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° 499
const dispatcher = await getProxyDispatcher(
  this.env as unknown as Record<string, unknown>,
  url
);

// Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° 500-508
const response = await fetch(url, ({
  method: "POST",
  headers: { ... },
  body: JSON.stringify(streamRequest),
  dispatcher,  // â† ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° dispatcher Ğ² fetch
}) as any);
```

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:**
- ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ dispatcher
- ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ² fetch
- Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

---

### 3. Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (src/gemini-client.ts)

```typescript
// Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° 500-508
if (dispatcher) {
  console.log("[GeminiAPI] Stream request will be routed through proxy");
} else {
  console.log("[GeminiAPI] Stream request will be sent directly (no proxy)");
}
```

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:**
- Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
- ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ² Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞµ

---

## ğŸ” Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### ĞœĞ°ÑĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ

```typescript
// Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ URL
HTTPS_PROXY=http://admin:SecurePass123@proxy.com:8080

// Ğ’ Ğ»Ğ¾Ğ³Ğ°Ñ…
[Proxy] Using proxy for https://...: http://admin:***@proxy.com:8080
```

**ĞšĞ°Ğº ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚:**
```typescript
const maskedProxyUrl = proxyUrl.replace(
  /(:\/\/)([^:]+):([^@]+)@/,  // Ğ˜Ñ‰ĞµÑ‚ :// user : password @
  "$1$2:***@"                  // Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ password Ğ½Ğ° ***
);
```

---

## ğŸ“ˆ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

### ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

- ProxyAgent ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ·Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
- ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ñ‡Ğ¸Ñ‚Ğ°ÑÑ‚ÑÑ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·
- ĞĞµÑ‚ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº NO_PROXY

### ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

- Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ undici (Ğ¸Ğ·Ğ±ĞµĞ³Ğ°ĞµÑ‚ bundling)
- Ğ Ğ°Ğ½Ğ½Ğ¸Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
- ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ² production

---

## ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸

```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
echo $HTTPS_PROXY
echo $NO_PROXY

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸
npm start 2>&1 | grep "\[Proxy\]"
```

### ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸

```bash
# Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ Ğ¿Ñ€Ğ¾ĞºÑĞ¸
curl -X POST http://localhost:3000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{"model": "gemini-2.5-flash", "messages": [{"role": "user", "content": "Hi"}]}'

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Ğ½Ğ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ:
# [Proxy] Using proxy for ...
# [GeminiAPI] Stream request will be routed through proxy
```

---

## ğŸ“š Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

- **[`src/config.ts`](src/config.ts)** - Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- **[`src/gemini-client.ts`](src/gemini-client.ts)** - Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
- **[`PROXY_USAGE.md`](PROXY_USAGE.md)** - Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
- **[`PROXY_EXAMPLES.md`](PROXY_EXAMPLES.md)** - ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹
- **[`PROXY_CHEATSHEET.md`](PROXY_CHEATSHEET.md)** - Ğ¨Ğ¿Ğ°Ñ€Ğ³Ğ°Ğ»ĞºĞ°
