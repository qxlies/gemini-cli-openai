# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ –≤ Gemini CLI OpenAI API

## üìã –û–±–∑–æ—Ä

API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Gemini API —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä. –≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è:
- –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ç–µ–π —Å –ø—Ä–æ–∫—Å–∏
- –û–±—Ö–æ–¥–∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env` —Ñ–∞–π–ª:

```bash
# –î–ª—è HTTPS –∑–∞–ø—Ä–æ—Å–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
HTTPS_PROXY=http://proxy-host:proxy-port

# –ò–ª–∏ –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
HTTP_PROXY=http://proxy-host:proxy-port

# –ò–ª–∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ–∫—Å–∏
ALL_PROXY=http://proxy-host:proxy-port
```

### –° –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

–ï—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ —Ç—Ä–µ–±—É–µ—Ç –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å:

```bash
HTTPS_PROXY=http://username:password@proxy-host:proxy-port
```

**‚ö†Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ü–∞—Ä–æ–ª–∏ –≤ –ª–æ–≥–∞—Ö –±—É–¥—É—Ç –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ `***`

### –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —Ö–æ—Å—Ç–æ–≤ (NO_PROXY)

–î–ª—è –æ–±—Ö–æ–¥–∞ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤:

```bash
NO_PROXY=localhost,127.0.0.1,.googleapis.com,internal.local
```

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
- `localhost` - —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
- `127.0.0.1` - —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
- `.example.com` - —Å—É—Ñ—Ñ–∏–∫—Å –¥–æ–º–µ–Ω–∞ (—Å —Ç–æ—á–∫–æ–π)
- `example.com` - —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ —Å—É—Ñ—Ñ–∏–∫—Å
- `*` - –æ–±—Ö–æ–¥ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –≤—Å–µ—Ö —Ö–æ—Å—Ç–æ–≤

## üìù –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –ü—Ä–∏–º–µ—Ä 1: –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–∫—Å–∏

```bash
# .env
HTTPS_PROXY=http://proxy.company.com:8080
NO_PROXY=localhost,127.0.0.1,.company.local
```

### –ü—Ä–∏–º–µ—Ä 2: –ü—Ä–æ–∫—Å–∏ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

```bash
# .env
HTTPS_PROXY=http://admin:SecurePass123@proxy.company.com:3128
```

### –ü—Ä–∏–º–µ—Ä 3: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

```bash
# .env
HTTPS_PROXY=http://192.168.1.100:8080
NO_PROXY=localhost,127.0.0.1,.internal.local,.googleapis.com,10.0.0.0/8
```

### –ü—Ä–∏–º–µ—Ä 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ
export HTTPS_PROXY=http://proxy.example.com:8080

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
npm start
```

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏

### –°–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–∫—Å–∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```
[Proxy] Using proxy for https://cloudcode-pa.googleapis.com/v1internal:streamGenerateContent?alt=sse: http://proxy.company.com:***@8080
[GeminiAPI] Stream request will be routed through proxy
```

### –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–æ–∫—Å–∏

```
[Proxy] No proxy configured in environment variables
[GeminiAPI] Stream request will be sent directly (no proxy)
```

### –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏ —Ö–æ—Å—Ç–æ–≤

```
[Proxy] Bypassing proxy for host: cloudcode-pa.googleapis.com (matched NO_PROXY rules)
[GeminiAPI] Stream request will be sent directly (no proxy)
```

### –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

```
[Proxy] Error creating proxy dispatcher: <error message>
[Proxy] undici.ProxyAgent not available
```

## üöÄ –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª

```bash
# .env
HTTPS_PROXY=http://proxy.example.com:8080
NO_PROXY=localhost,127.0.0.1
GEMINI_API_KEY=your-api-key
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
npm install
npm start
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

```
[Proxy] Using proxy for https://cloudcode-pa.googleapis.com/v1internal:streamGenerateContent?alt=sse: http://proxy.example.com:8080
[GeminiAPI] Attempt 1/1 using account index 0, project default-project
[GeminiAPI] Stream request will be routed through proxy
[GeminiAPI] Starting stream generation
```

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    ‚Üì
GeminiApiClient.streamContent()
    ‚Üì
getProxyDispatcher() ‚Üê –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    ‚Üì
fetch() —Å dispatcher
    ‚Üì
ProxyAgent (undici)
    ‚Üì
–ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä
    ‚Üì
Google Gemini API
```

### –§–∞–π–ª—ã, –æ—Ç–≤–µ—á–∞—é—â–∏–µ –∑–∞ –ø—Ä–æ–∫—Å–∏

1. **[`src/config.ts`](src/config.ts:23-57)** - –§—É–Ω–∫—Ü–∏—è `getProxyDispatcher()`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –°–æ–∑–¥–∞–µ—Ç ProxyAgent
   - –õ–æ–≥–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–∫—Å–∏

2. **[`src/gemini-client.ts`](src/gemini-client.ts:499-508)** - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏
   - –ü–æ–ª—É—á–∞–µ—Ç dispatcher –æ—Ç `getProxyDispatcher()`
   - –ü–µ—Ä–µ–¥–∞–µ—Ç –µ–≥–æ –≤ `fetch()` –∑–∞–ø—Ä–æ—Å
   - –õ–æ–≥–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏

## ‚öôÔ∏è –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–§—É–Ω–∫—Ü–∏—è `getProxyDispatcher()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:

### –î–ª—è HTTPS –∑–∞–ø—Ä–æ—Å–æ–≤:
1. `HTTPS_PROXY` (–ø—Ä–æ–ø–∏—Å–Ω—ã–µ)
2. `https_proxy` (—Å—Ç—Ä–æ—á–Ω—ã–µ)
3. `ALL_PROXY` (–ø—Ä–æ–ø–∏—Å–Ω—ã–µ)
4. `all_proxy` (—Å—Ç—Ä–æ—á–Ω—ã–µ)

### –î–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤:
1. `HTTP_PROXY` (–ø—Ä–æ–ø–∏—Å–Ω—ã–µ)
2. `http_proxy` (—Å—Ç—Ä–æ—á–Ω—ã–µ)
3. `ALL_PROXY` (–ø—Ä–æ–ø–∏—Å–Ω—ã–µ)
4. `all_proxy` (—Å—Ç—Ä–æ—á–Ω—ã–µ)

### NO_PROXY (–∏—Å–∫–ª—é—á–µ–Ω–∏—è):
1. `NO_PROXY` (–ø—Ä–æ–ø–∏—Å–Ω—ã–µ)
2. `no_proxy` (—Å—Ç—Ä–æ—á–Ω—ã–µ)

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

- ‚úÖ **Node.js** - –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- ‚ùå **Cloudflare Workers** - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (—Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω–µ—Ç `undefined`)
- ‚ùå **–ë—Ä–∞—É–∑–µ—Ä** - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js –≤–µ—Ä—Å–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π `undici` (–æ–±—ã—á–Ω–æ –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ Node.js 16+)
- –î–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä—É –∏–∑ –≤–∞—à–µ–π —Å–µ—Ç–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ü–∞—Ä–æ–ª–∏ –≤ URL –ø—Ä–æ–∫—Å–∏ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Å–∫–∏—Ä—É—é—Ç—Å—è** –≤ –ª–æ–≥–∞—Ö
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç `undici` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –±–∞–Ω–¥–ª–∏–Ω–≥–æ–º
- –û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–∫—Å–∏-–∞–≥–µ–Ω—Ç–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo $HTTPS_PROXY
echo $NO_PROXY

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏
curl -x http://proxy.example.com:8080 https://cloudcode-pa.googleapis.com
```

### –í–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏
- –ò—Å–∫–ª—é—á–µ–Ω–∏—è —Ö–æ—Å—Ç–æ–≤
- –û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–∫—Å–∏-–∞–≥–µ–Ω—Ç–∞

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π `[Proxy]` –∏ `[GeminiAPI]`

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| "No proxy configured" | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env` |
| "Bypassing proxy" | –•–æ—Å—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `NO_PROXY` —Å–ø–∏—Å–∫–µ |
| "Connection refused" | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞ |
| "Authentication failed" | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –≤ `HTTPS_PROXY` |

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è undici ProxyAgent](https://undici.nodejs.org/#/docs?id=class-proxyagent)
- [–°—Ç–∞–Ω–¥–∞—Ä—Ç NO_PROXY](https://about.gitlab.com/blog/2021/01/27/we-need-to-talk-about-no_proxy/)
- [–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏](https://www.gnu.org/software/wget/manual/wget.html#Proxies)
